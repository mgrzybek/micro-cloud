{% if ip_address | length > 0 %}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: idp-endpoint
  namespace: platform-management
spec:
  secretName: idp-endpoint
  duration: 2160h # 90d
  renewBefore: 360h # 15d
  subject:
    organizations:
      - {{pki_org}}
  commonName: idp.{{ts_suffix}}
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
  dnsNames:
    - idp.{{ts_suffix}}
  uris:
    - spiffe://cluster.local/ns/default/sa/default
  ipAddresses:
    - {{ip_address}}
  issuerRef:
    name: cfssl-internal-ca
    kind: ClusterIssuer
    group: cfssl-issuer.wikimedia.org
{% endif %}
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: idp
  namespace: platform-management
spec:
  gatewayClassName: cilium
  listeners:
{% if ip_address | length > 0 %}
  - protocol: HTTPS
    port: 443
    name: idp-https
    allowedRoutes:
      namespaces:
        from: Same
    hostname: idp.{{ts_suffix}}
    tls:
      certificateRefs:
      - kind: Secret
        name: idp-endpoint
{% else %}
  - protocol: HTTP
    port: 80
    name: idp-http
    allowedRoutes:
      namespaces:
        from: Same
    hostname: idp.{{ts_suffix}}
{% endif %}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: http-authentik
  namespace: platform-management
spec:
  parentRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: idp
    namespace: platform-management
  rules:
  - backendRefs:
    - group: ""
      kind: Service
      name: idp-authentik-server
      port: 80
      weight: 1
    matches:
    - path:
        type: PathPrefix
        value: /